pipeline {
  agent any
  options { timestamps() }

  parameters {
    string(name: 'ACR_LOGIN_SERVER', defaultValue: 'bhattiacr20314.azurecr.io', description: 'e.g. myregistry.azurecr.io')
    credentials(name: 'ACR_CREDENTIALS', defaultValue: 'acr-creds',
      description: 'ACR username/password (admin user or SP with AcrPush)',
      credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl')
  }

  environment {
    TEST_REPO = 'jenkins-acr-smoketest'
    TEST_TAG  = "build-${env.BUILD_NUMBER}"
  }

  stages {
    stage('Checkout') { steps { checkout scm } }

    stage('Tooling check') {
      steps {
        sh '''
          set -e
          docker --version
          echo "Docker is available on this agent."
        '''
      }
    }

    stage('Login to ACR') {
      steps {
        withCredentials([usernamePassword(credentialsId: params.ACR_CREDENTIALS,
                          usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
          sh '''
            set -eu
            echo "$REG_PASS" | docker login "${ACR_LOGIN_SERVER}" --username "$REG_USER" --password-stdin
            echo "Authenticated to ${ACR_LOGIN_SERVER}"
          '''
        }
      }
    }

    stage('Push & Pull smoke test') {
      steps {
        sh '''
          set -eu
          BASE_IMAGE=busybox:latest
          docker pull "${BASE_IMAGE}"
          TARGET_IMAGE="${ACR_LOGIN_SERVER}/${TEST_REPO}:${TEST_TAG}"
          docker tag "${BASE_IMAGE}" "${TARGET_IMAGE}"
          docker push "${TARGET_IMAGE}"
          docker pull "${TARGET_IMAGE}"
          echo "ACR push/pull verification succeeded for ${TARGET_IMAGE}"
        '''
      }
    }

    stage('Cleanup (local)') {
      steps {
        sh '''
          set -e
          TARGET_IMAGE="${ACR_LOGIN_SERVER}/${TEST_REPO}:${TEST_TAG}"
          docker rmi -f "${TARGET_IMAGE}" || true
        '''
      }
    }
  }

  post {
    always {
      sh 'docker logout "${ACR_LOGIN_SERVER}" || true'
      echo 'Pipeline finished.'
    }
    success { echo 'ACR connectivity & auth: OK (push/pull succeeded).' }
    failure { echo 'ACR connectivity/auth test failed. Check previous stage logs.' }
  }
}
