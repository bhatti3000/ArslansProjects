pipeline {
  agent any
  options { timestamps(); parallelsAlwaysFailFast() }   // stop other branches if one fails

  environment {
    REGISTRY = 'bhattiacr20314.azurecr.io'
    CREDS    = 'acr-creds'
    TAG      = "${env.BUILD_NUMBER}"
    VOTE_DIR   = 'AppHTML/vote'
    WORKER_DIR = 'AppHTML/worker'
    RESULT_DIR = 'AppHTML/result'
  }

  stages {
    stage('Preflight') {
      steps {
        sh '''
          set -e
          echo "REGISTRY=$REGISTRY"
          docker version >/dev/null
        '''
      }
    }

  post {
    success { echo '✅ Pipeline PASSED' }
    failure { echo '❌ Pipeline FAILED' }
    always  { sh 'docker image prune -f || true' }
  }
}
